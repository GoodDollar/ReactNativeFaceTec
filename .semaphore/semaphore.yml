version: v1.0
name: Release

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

execution_time_limit:
  minutes: 5

blocks:
  - name: Install and Cache Dependencies
    dependencies: []
    task:
      secrets:
        - name: Github Package Access
      prologue:
        commands:
          - checkout
      jobs:
        - name: Node Modules Install and Cache
          commands:
            - export CHECKSUM=$(checksum package-lock.json)
            - cache has_key node-modules-$CHECKSUM || (npm ci && cache store node-modules-$CHECKSUM node_modules)

promotions:
  - name: Release Promotion
    pipeline_file: release_artifact.yml
    auto_promote:
      when: "branch = 'master'"
